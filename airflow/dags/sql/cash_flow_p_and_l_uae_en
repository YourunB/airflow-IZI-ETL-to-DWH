DROP MATERIALIZED VIEW IF EXISTS models.cash_flow_p_and_l_uae_en;
CREATE MATERIALIZED VIEW models.cash_flow_p_and_l_uae_en AS
  WITH
    source AS (
      SELECT
        bu.id_club,
        p.id_balance_user,
        bu.id_balance AS id_type_balance,
        p.date AS payment_time,
        p.id,
        pt.direct,
        p.id_payment_type,
        pt.method AS id_grp_payment_type,
        pt.profit,
        p.amount,
        p.id_reservation_terminal,
        p.id_subscription_user,
        p.id_reservation_shop,
        p.id_parent,
        pt.id_parent AS id_payment_type_parent,
        p.date + (c.time_zone * INTERVAL '1 second') AS payment_time_local,
        -- Revenue columns
        CASE
          WHEN (
            p.id_payment_type IN (5, 8, 23, 38, 41, 44, 65, 68, 71, 11, 47, 74)
            OR p.id_payment_type IN (26, 29, 32, 35)
            OR p.id_payment_type IN (17, 20, 98, 62, 185)
          )
          AND pt.profit = 1
          AND pt.method = 1 THEN p.amount
        END AS "Cash",
        CASE
          WHEN (
            p.id_payment_type IN (5, 8, 23, 38, 41, 44, 65, 68, 71, 11, 47, 74)
            OR p.id_payment_type IN (26, 29, 32, 35)
            OR p.id_payment_type IN (17, 20, 98, 62, 185)
          )
          AND pt.profit = 1
          AND pt.method = 2 THEN p.amount
        END AS "POS",
        CASE
          WHEN (
            p.id_payment_type IN (5, 8, 23, 38, 41, 44, 65, 68, 71, 11, 47, 74)
            OR p.id_payment_type IN (26, 29, 32, 35)
            OR p.id_payment_type IN (17, 20, 98, 62, 185)
          )
          AND pt.profit = 1
          AND pt.method = 3 THEN p.amount
        END AS "Online (APP)",
        CASE
          WHEN p.id_payment_type IN (166, 167)
          AND pt.profit = 1 THEN p.amount
        END AS "Gift cards (Revenue)",
        CASE
          WHEN p.id_payment_type IN (169, 170)
          AND pt.profit = 1 THEN p.amount
        END AS "Event (revenue)",
        CASE
          WHEN p.id_payment_type IN (172, 173)
          AND pt.profit = 1 THEN p.amount
        END AS "Other (revenue)",
        -- Expense columns
        CASE
          WHEN p.id_payment_type IN (103, 104)
          AND pt.profit = 0 THEN p.amount
        END AS "Staff salaries (expense)",
        CASE
          WHEN p.id_payment_type IN (106, 107)
          AND pt.profit = 0 THEN p.amount
        END AS "Manager salaries (expense)",
        CASE
          WHEN p.id_payment_type IN (100, 101)
          AND pt.profit = 0 THEN p.amount
        END AS "Utilities (expense)",
        CASE
          WHEN p.id_payment_type IN (115, 116)
          AND pt.profit = 0 THEN p.amount
        END AS "Internet (expense)",
        CASE
          WHEN p.id_payment_type IN (109, 110)
          AND pt.profit = 0 THEN p.amount
        END AS "Team bonuses (expense)",
        CASE
          WHEN p.id_payment_type IN (112, 113)
          AND pt.profit = 0 THEN p.amount
        END AS "Marketing and advertising (expense)",
        CASE
          WHEN p.id_payment_type IN (118, 119)
          AND pt.profit = 0 THEN p.amount
        END AS "Bar expenses (expense)",
        CASE
          WHEN p.id_payment_type IN (121, 122)
          AND pt.profit = 0 THEN p.amount
        END AS "Cleaning (expense)",
        CASE
          WHEN p.id_payment_type IN (124, 125)
          AND pt.profit = 0 THEN p.amount
        END AS "CRM and digital payments (expense)",
        CASE
          WHEN p.id_payment_type IN (127, 128)
          AND pt.profit = 0 THEN p.amount
        END AS "Banking services (expense)",
        CASE
          WHEN p.id_payment_type IN (130, 131)
          AND pt.profit = 0 THEN p.amount
        END AS "Accounting services (expense)",
        CASE
          WHEN p.id_payment_type IN (133, 134)
          AND pt.profit = 0 THEN p.amount
        END AS "Equipment (expense)",
        CASE
          WHEN p.id_payment_type IN (136, 137)
          AND pt.profit = 0 THEN p.amount
        END AS "Repair (expense)",
        CASE
          WHEN p.id_payment_type IN (139, 140)
          AND pt.profit = 0 THEN p.amount
        END AS "Household expenses (expense)",
        CASE
          WHEN p.id_payment_type IN (142, 143)
          AND pt.profit = 0 THEN p.amount
        END AS "Tournament prize pool (expense)",
        CASE
          WHEN p.id_payment_type IN (145, 146)
          AND pt.profit = 0 THEN p.amount
        END AS "Transportation expenses (expense)",
        CASE
          WHEN p.id_payment_type IN (148, 149)
          AND pt.profit = 0 THEN p.amount
        END AS "Rent (expense)",
        CASE
          WHEN p.id_payment_type IN (151, 152)
          AND pt.profit = 0 THEN p.amount
        END AS "Legal expenses (expense)",
        CASE
          WHEN p.id_payment_type IN (154, 155)
          AND pt.profit = 0 THEN p.amount
        END AS "Other expenses (expense)",
        CASE
          WHEN p.id_payment_type IN (158, 159)
          AND pt.profit = 0 THEN p.amount
        END AS "Miscellaneous expenses (expense)",
        CASE
          WHEN p.id_payment_type IN (160, 161)
          AND pt.profit = 0 THEN p.amount
        END AS "VAT (expense)",
        CASE
          WHEN p.id_payment_type IN (163, 164)
          AND pt.profit = 0 THEN p.amount
        END AS "Taxes and fees (expense)",
        CASE
          WHEN p.id_payment_type IN (169, 170)
          AND pt.profit = 0 THEN p.amount
        END AS "Event payments in cash (expense)",
        CASE
          WHEN p.id_payment_type IN (172, 173)
          AND pt.profit = 0 THEN p.amount
        END AS "Payments for other income (expense)"
      FROM
        billing.payment p
        JOIN billing.payment_type pt ON p.id_payment_type = pt.id
        LEFT JOIN billing.balance_user bu ON p.id_balance_user = bu.id
        LEFT JOIN billing.balance b ON bu.id_balance = b.id
        LEFT JOIN cntrl.club AS c ON c.id = bu.id_club
      WHERE
        pt.state = 1
        AND bu.id_balance = 1
    ),
    metrics_unpacked AS (
      SELECT
        s.id_club,
        s.payment_time,
        s.payment_time_local,
        s.id_payment_type,
        s.id_grp_payment_type,
        m.metric_name AS "Метрика",
        m.metric_value AS "Значение",
        m.metric_order AS "Порядок"
      FROM
        source s
        CROSS JOIN LATERAL (
          VALUES
            ('Cash', "Cash"::double precision, 1.2),
            ('POS', "POS"::double precision, 1.3),
            (
              'Online (APP)',
              "Online (APP)"::double precision,
              1.4
            ),
            (
              'Gift cards (Revenue)',
              "Gift cards (Revenue)"::double precision,
              1.51
            ),
            (
              'Event (revenue)',
              "Event (revenue)"::double precision,
              1.52
            ),
            (
              'Other (revenue)',
              "Other (revenue)"::double precision,
              1.53
            ),
            (
              'Other revenue',
              COALESCE("Gift cards (Revenue)", 0) + COALESCE("Event (revenue)", 0) + COALESCE("Other (revenue)", 0),
              1.5
            ),
            (
              'Total revenue',
              COALESCE("Cash", 0) + COALESCE("POS", 0) + COALESCE("Online (APP)", 0) + COALESCE("Gift cards (Revenue)", 0) + COALESCE("Event (revenue)", 0) + COALESCE("Other (revenue)", 0),
              1.1
            ),
            (
              'Staff salaries (expense)',
              "Staff salaries (expense)"::double precision,
              2.11
            ),
            (
              'Manager salaries (expense)',
              "Manager salaries (expense)"::double precision,
              2.12
            ),
            (
              'Utilities (expense)',
              "Utilities (expense)"::double precision,
              2.13
            ),
            (
              'Internet (expense)',
              "Internet (expense)"::double precision,
              2.14
            ),
            (
              'Team bonuses (expense)',
              "Team bonuses (expense)"::double precision,
              2.15
            ),
            (
              'Marketing and advertising (expense)',
              "Marketing and advertising (expense)"::double precision,
              2.16
            ),
            (
              'Bar expenses (expense)',
              "Bar expenses (expense)"::double precision,
              2.17
            ),
            (
              'Cleaning (expense)',
              "Cleaning (expense)"::double precision,
              2.18
            ),
            (
              'CRM and digital payments (expense)',
              "CRM and digital payments (expense)"::double precision,
              2.19
            ),
            (
              'Banking services (expense)',
              "Banking services (expense)"::double precision,
              2.191
            ),
            (
              'Accounting services (expense)',
              "Accounting services (expense)"::double precision,
              2.192
            ),
            (
              'Equipment (expense)',
              "Equipment (expense)"::double precision,
              2.193
            ),
            (
              'Repair (expense)',
              "Repair (expense)"::double precision,
              2.194
            ),
            (
              'Household expenses (expense)',
              "Household expenses (expense)"::double precision,
              2.195
            ),
            (
              'Tournament prize pool (expense)',
              "Tournament prize pool (expense)"::double precision,
              2.196
            ),
            (
              'Transportation expenses (expense)',
              "Transportation expenses (expense)"::double precision,
              2.197
            ),
            (
              'Rent (expense)',
              "Rent (expense)"::double precision,
              2.198
            ),
            (
              'Legal expenses (expense)',
              "Legal expenses (expense)"::double precision,
              2.199
            ),
            (
              'Other expenses (expense)',
              "Other expenses (expense)"::double precision,
              2.1991
            ),
            (
              'Miscellaneous expenses (expense)',
              "Miscellaneous expenses (expense)"::double precision,
              2.1992
            ),
            (
              'VAT (expense)',
              "VAT (expense)"::double precision,
              2.1993
            ),
            (
              'Taxes and fees (expense)',
              "Taxes and fees (expense)"::double precision,
              2.1994
            ),
            (
              'Event payments in cash (expense)',
              "Event payments in cash (expense)"::double precision,
              2.1995
            ),
            (
              'Payments for other income (expense)',
              "Payments for other income (expense)"::double precision,
              2.1996
            ),
            (
              'Total expenses',
              COALESCE("Team bonuses (expense)", 0) + COALESCE("Manager salaries (expense)", 0) + COALESCE("Staff salaries (expense)", 0) + COALESCE("Internet (expense)", 0) + COALESCE("Utilities (expense)", 0) + COALESCE("Marketing and advertising (expense)", 0) + COALESCE("Bar expenses (expense)", 0) + COALESCE("Cleaning (expense)", 0) + COALESCE("CRM and digital payments (expense)", 0) + COALESCE("Banking services (expense)", 0) + COALESCE("Accounting services (expense)", 0) + COALESCE("Equipment (expense)", 0) + COALESCE("Repair (expense)", 0) + COALESCE("Household expenses (expense)", 0) + COALESCE("Tournament prize pool (expense)", 0) + COALESCE("Transportation expenses (expense)", 0) + COALESCE("Rent (expense)", 0) + COALESCE("Legal expenses (expense)", 0) + COALESCE("Other expenses (expense)", 0) + COALESCE("Miscellaneous expenses (expense)", 0) + COALESCE("VAT (expense)", 0) + COALESCE("Taxes and fees (expense)", 0) + COALESCE("Event payments in cash (expense)", 0) + COALESCE("Payments for other income (expense)", 0),
              2.1
            ),
            (
              'Profit',
              (
                (
                  COALESCE("Cash", 0) + COALESCE("POS", 0) + COALESCE("Online (APP)", 0) + COALESCE("Gift cards (Revenue)", 0) + COALESCE("Event (revenue)", 0) + COALESCE("Other (revenue)", 0)
                ) - (
                  COALESCE("Team bonuses (expense)", 0) + COALESCE("Manager salaries (expense)", 0) + COALESCE("Staff salaries (expense)", 0) + COALESCE("Internet (expense)", 0) + COALESCE("Utilities (expense)", 0) + COALESCE("Marketing and advertising (expense)", 0) + COALESCE("Bar expenses (expense)", 0) + COALESCE("Cleaning (expense)", 0) + COALESCE("CRM and digital payments (expense)", 0) + COALESCE("Banking services (expense)", 0) + COALESCE("Accounting services (expense)", 0) + COALESCE("Equipment (expense)", 0) + COALESCE("Repair (expense)", 0) + COALESCE("Household expenses (expense)", 0) + COALESCE("Tournament prize pool (expense)", 0) + COALESCE("Transportation expenses (expense)", 0) + COALESCE("Rent (expense)", 0) + COALESCE("Legal expenses (expense)", 0) + COALESCE("Other expenses (expense)", 0) + COALESCE("Miscellaneous expenses (expense)", 0) + COALESCE("VAT (expense)", 0) + COALESCE("Taxes and fees (expense)", 0) + COALESCE("Event payments in cash (expense)", 0) + COALESCE("Payments for other income (expense)", 0)
                )
              ),
              3.1
            )
        ) AS m (metric_name, metric_value, metric_order)
      WHERE
        m.metric_value IS NOT NULL
        AND m.metric_value != 0
    )
  SELECT
    id_club,
    payment_time,
    payment_time_local,
    id_payment_type,
    id_grp_payment_type,
    "Метрика",
    "Значение",
    "Порядок"
  FROM
    metrics_unpacked
